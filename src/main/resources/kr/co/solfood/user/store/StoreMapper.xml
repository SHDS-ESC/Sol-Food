<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.solfood.user.store.StoreMapper">

   <!-- 전체 목록 조회 -->
    <select id="selectAllStore" resultType="kr.co.solfood.user.store.StoreVO">
        SELECT 
            store_id,
            store_name, 
            store_category, 
            store_avgstar, 
            store_mainimage,
            store_address,
            store_tel
        FROM store
        ORDER BY store_avgstar DESC, store_id DESC
    </select>
    <!-- 가게 ID로 가게 정보 조회 -->
    <select id="getStoreById" parameterType="int" resultType="kr.co.solfood.user.store.StoreVO">
        SELECT
            store_id,
            store_name,
            store_address,
            store_latitude,
            store_longitude,
            store_avgstar,
            store_intro,
            store_mainimage,
            store_category,
            store_capacity,
            store_tel
        FROM store
        WHERE store_id = #{storeId}
    </select>

    <!-- 카테고리별 조회 (성능 개선: 인덱스 활용하도록록 수정) -->
    <select id="selectCategoryStore" resultType="kr.co.solfood.user.store.StoreVO">
        SELECT 
            store_id,
            store_name, 
            store_category, 
            store_avgstar, 
            store_mainimage,
            store_address,
            store_tel
        FROM store
        <where>
            <if test="category != null and category != '' and category != '전체'">
                AND store_category LIKE CONCAT(#{category}, '%')
            </if>
        </where>
        ORDER BY store_avgstar DESC, store_id DESC
        LIMIT 100
    </select>

    <!-- 새 가게 정보 추가 (크롤링용) -->
    <insert id="insertStore" parameterType="kr.co.solfood.user.store.StoreVO">
        INSERT INTO store (
            store_name, 
            store_address, 
            store_latitude, 
            store_longitude, 
            store_avgstar, 
            store_intro, 
            store_mainimage, 
            store_category, 
            store_capacity, 
            store_tel
        ) VALUES (
            #{storeName}, 
            #{storeAddress}, 
            #{storeLatitude}, 
            #{storeLongitude}, 
            #{storeAvgstar}, 
            #{storeIntro}, 
            #{storeMainimage}, 
            #{storeCategory}, 
            #{storeCapacity}, 
            #{storeTel}
        )
    </insert>

    <!-- 중복 체크용 쿼리 -->
    <select id="countByNameAndAddress" resultType="int">
        SELECT COUNT(*)
        FROM store
        WHERE store_name = #{storeName} 
        AND store_address = #{storeAddress}
    </select>

</mapper>