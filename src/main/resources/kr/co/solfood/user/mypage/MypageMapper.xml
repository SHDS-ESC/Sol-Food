<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.solfood.user.mypage.MypageMapper">
    <update id="update" parameterType="kr.co.solfood.user.login.UserVO">
        UPDATE users
        SET
            company_id = #{companyId},
            department_id = #{departmentId},
            users_email = #{usersEmail},
            users_nickname = #{usersNickname},
            users_name = #{usersName},
            users_birth = #{usersBirth},
            users_gender = #{usersGender},
            users_tel = #{usersTel},
            users_profile = #{usersProfile}
        WHERE users_id = #{usersId}
    </update>

    <update id="updateStatusToWithdraw" parameterType="long" >
        UPDATE users
        SET
            users_status = 'inactive'
        WHERE users_id = #{usersId}
    </update>

    <select id="getLikedStores" resultType="kr.co.solfood.user.store.StoreVO">
        SELECT
            s.store_id,
            s.owner_id,
            s.category_id,
            s.store_name,
            s.store_address,
            s.store_latitude,
            s.store_longitude,
            s.store_avgstar,
            s.store_intro,
            s.store_mainimage,
            s.store_tel,
            s.store_status,
            COALESCE(c.category_name, '기타') as storeCategory,
            true as liked
        FROM store s
        JOIN user_likes ul ON s.store_id = ul.store_id
        LEFT JOIN category c ON s.category_id = c.category_id
        WHERE ul.users_id = #{usersId}
        AND (s.store_status = 'approved' OR s.store_status IS NULL)
        ORDER BY ul.userlikes_id DESC
        LIMIT #{StoreVO.pageSize} OFFSET #{StoreVO.offset}
    </select>

    <select id="countLikedStores" resultType="int">
        SELECT COUNT(*)
        FROM user_likes ul
        JOIN store s ON ul.store_id = s.store_id
        WHERE ul.users_id = #{usersId}
        AND (s.store_status = 'approved' OR s.store_status IS NULL)
    </select>

</mapper>