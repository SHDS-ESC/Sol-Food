// ==================== Ï†ÑÏó≠ Î≥ÄÏàò ====================
let map;
let currentPosition;
let placesService;
let markers = [];
let currentCategory = 'Ï†ÑÏ≤¥';
let categoryConfig = null;
let currentInfoWindow = null;
let isSearchMode = false;
let currentSearchKeyword = '';

// ==================== Ï¥àÍ∏∞Ìôî ====================
document.addEventListener('DOMContentLoaded', function() {
    currentCategory = 'Ï†ÑÏ≤¥';
    loadCategoryConfig();
    
    const listContainer = document.getElementById('listContainer');
    const listDisplay = window.getComputedStyle(listContainer).display;
    if (listDisplay === 'block' || listDisplay === '') {
        fallbackFilterStoreList('Ï†ÑÏ≤¥');
    }
});

function loadCategoryConfig() {
    fetch('/solfood/user/store/api/category/config')
        .then(response => response.json())
        .then(data => {
            categoryConfig = data.data || data;
        })
        .catch(error => {
            console.error('Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï Î°úÎî© Ïã§Ìå®:', error);
        });
}

// ==================== ÌôîÎ©¥ Ï†ÑÌôò ====================
function showMap() {
    document.getElementById('mapBtn').classList.add('btn-active');
    document.getElementById('listBtn').classList.remove('btn-active');
    document.getElementById('mapContainer').style.display = 'flex';
    document.getElementById('listContainer').style.display = 'none';
    document.querySelector('.app-container').classList.add('map-view');

    if (!map) {
        initializeMap();
    } else {
        setTimeout(() => {
            map.relayout();
            if (currentPosition) {
                map.setCenter(currentPosition);
            }
        }, 100);
    }
}

function showList() {
    document.getElementById('listBtn').classList.add('btn-active');
    document.getElementById('mapBtn').classList.remove('btn-active');
    document.getElementById('listContainer').style.display = 'block';
    document.getElementById('mapContainer').style.display = 'none';
    document.querySelector('.app-container').classList.remove('map-view');
}

// ==================== ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ====================
function initializeMap() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                currentPosition = new kakao.maps.LatLng(lat, lng);
                createMap(currentPosition);
            },
            error => {
                const defaultPosition = new kakao.maps.LatLng(37.566826, 126.9786567);
                currentPosition = defaultPosition;
                createMap(defaultPosition);
            }
        );
    } else {
        const defaultPosition = new kakao.maps.LatLng(37.566826, 126.9786567);
        currentPosition = defaultPosition;
        createMap(defaultPosition);
    }
}

function createMap(position) {
    const mapContainer = document.getElementById('map');
    const mapOption = {
        center: position,
        level: 3
    };

    map = new kakao.maps.Map(mapContainer, mapOption);
    placesService = new kakao.maps.services.Places();

    const myLocationMarker = new kakao.maps.Marker({
        position: position,
        map: map
    });

    const infowindow = new kakao.maps.InfoWindow({
        content: '<div style="padding:5px;font-size:12px;color:#0066cc;font-weight:bold;">üìç ÎÇ¥ ÏúÑÏπò</div>'
    });
    infowindow.open(map, myLocationMarker);

    setTimeout(() => {
        map.relayout();
        map.setCenter(position);
        searchMapCategory('Ï†ÑÏ≤¥');
        
        document.querySelectorAll('.map-category-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.map-category-btn[onclick*="Ï†ÑÏ≤¥"]').classList.add('active');
    }, 100);
}

// ==================== Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù ====================
function selectCategory(element, category) {
    // Í≤ÄÏÉâ Î™®ÎìúÏù∏ Í≤ΩÏö∞ Í≤ÄÏÉâ Ìï¥Ï†ú
    if (isSearchMode) {
        // Í≤ÄÏÉâÏ∞Ω Ï¥àÍ∏∞Ìôî
        document.getElementById('searchInput').value = '';
        
        // Í≤ÄÏÉâ Ìó§Îçî Ï†úÍ±∞
        const searchHeader = document.getElementById('searchHeader');
        if (searchHeader) {
            searchHeader.remove();
        }
        
        isSearchMode = false;
        currentSearchKeyword = '';
    }
    
    document.querySelectorAll('.category-item').forEach(item => {
        item.classList.remove('active');
    });
    element.classList.add('active');
    currentCategory = category;
    
    const extendedCategories = document.getElementById('extendedCategories');
    const isMoreOpen = extendedCategories && extendedCategories.style.display === 'grid';
    
    if (isMoreOpen) {
        setTimeout(() => {
            toggleMoreCategories();
        }, 300);
    }
    
    const mapContainer = document.getElementById('mapContainer');
    const listContainer = document.getElementById('listContainer');
    const mapDisplay = window.getComputedStyle(mapContainer).display;
    const listDisplay = window.getComputedStyle(listContainer).display;
    const isMapView = mapDisplay === 'flex';
    const isListView = listDisplay === 'block' || listDisplay === '';

    if (isListView) {
        fallbackFilterStoreList(category);
    }
    if (isMapView) {
        searchMapCategory(category);
    }
    if (!isMapView && !isListView) {
        fallbackFilterStoreList(category);
    }
}

function selectMapCategory(element, category) {
    document.querySelectorAll('.map-category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    element.classList.add('active');
    currentCategory = category;
    
    if (map && placesService && currentPosition) {
        searchMapCategory(category);
    }
}

function toggleMoreCategories() {
    const extendedCategories = document.getElementById('extendedCategories');
    const moreText = document.getElementById('moreText');
    
    if (extendedCategories.style.display === 'grid') {
        extendedCategories.style.display = 'none';
        moreText.textContent = 'ÎçîÎ≥¥Í∏∞';
    } else {
        extendedCategories.style.display = 'grid';
        moreText.textContent = 'Ï†ëÍ∏∞';
    }
}

// ==================== Î™©Î°ù ÌïÑÌÑ∞ÎßÅ ====================
function fallbackFilterStoreList(category) {
    const storeCards = document.querySelectorAll('.store-card');
    let filteredCount = 0;
    
    storeCards.forEach(card => {
        let storeCategoryText = card.getAttribute('data-category');
        
        if (!storeCategoryText) {
            const storeCategory = card.querySelector('.store-category');
            if (storeCategory) {
                storeCategoryText = storeCategory.textContent.trim();
            }
        }
        
        if (storeCategoryText) {
            if (category === 'Ï†ÑÏ≤¥') {
                card.style.display = 'block';
                filteredCount++;
            } else {
                if (isCategoryMatch(storeCategoryText, category)) {
                    card.style.display = 'block';
                    filteredCount++;
                } else {
                    card.style.display = 'none';
                }
            }
        } else {
            card.style.display = 'block';
            filteredCount++;
        }
    });
}

function isCategoryMatch(storeCategory, selectedCategory) {
    if (selectedCategory === 'Ï†ÑÏ≤¥') {
        return true;
    }

    const storeCat = storeCategory.toLowerCase();
    const selectedCat = selectedCategory.toLowerCase();
    
    if (storeCat.includes(selectedCat)) {
        return true;
    }
    
    if (categoryConfig && categoryConfig.matchingKeywords) {
        const keywords = categoryConfig.matchingKeywords[selectedCategory];
        if (keywords) {
            return keywords.some(keyword => 
                storeCat.includes(keyword.toLowerCase())
            );
        }
    }
    
    return false;
}

// ==================== ÏßÄÎèÑ Í≤ÄÏÉâ ====================
function searchMapCategory(category) {
    if (map && placesService && currentPosition) {
        clearMarkers();
        closeAllInfoWindows();

        let keyword = '';
        if (categoryConfig && categoryConfig.searchKeywords) {
            keyword = categoryConfig.searchKeywords[category] || category;
        } else {
            keyword = category;
        }

        const options = {
            location: currentPosition,
            radius: 1000,
            sort: kakao.maps.services.SortBy.DISTANCE
        };

        placesService.keywordSearch(keyword, placesSearchCB, options);
    }
}

function placesSearchCB(data, status, pagination) {
    if (status === kakao.maps.services.Status.OK) {
        for (let i = 0; i < data.length; i++) {
            displayMarker(data[i]);
        }
    }
}

function displayMarker(place) {
    const marker = new kakao.maps.Marker({
        map: map,
        position: new kakao.maps.LatLng(place.y, place.x)
    });

    markers.push(marker);

    kakao.maps.event.addListener(marker, 'click', function() {
        closeAllInfoWindows();
        
        const content = createDetailedInfoWindow(place);
        const infowindow = new kakao.maps.InfoWindow({
            content: content,
            removable: false
        });

        currentInfoWindow = infowindow;
        infowindow.open(map, marker);
    });
}

function createDetailedInfoWindow(place) {
    const categoryTag = extractCategoryTag(place.category_name);
    
    let content = '<div class="custom-infowindow">';
    content += '<div class="infowindow-header">';
    content += '<button class="infowindow-close" onclick="closeCurrentInfoWindow()">√ó</button>';
    content += '<h3 class="store-title">' + place.place_name + '</h3>';
    content += '<span class="store-category-tag">' + categoryTag + '</span>';
    content += '</div>';
    
    content += '<div class="infowindow-body">';
    content += '<div class="menu-image-container">';
    content += '<div class="no-image-placeholder">';
    content += '<i class="bi bi-image" style="font-size: 24px; color: #dee2e6;"></i><br>';
    content += '<span>ÎåÄÌëú Î©îÎâ¥ Ïù¥ÎØ∏ÏßÄ</span>';
    content += '</div>';
    content += '</div>';
    
    content += '<div class="store-info">';
    content += '<div class="store-info-item">';
    content += '<i class="bi bi-geo-alt store-info-icon"></i>';
    content += '<span>' + (place.road_address_name || place.address_name) + '</span>';
    content += '</div>';
    
    if (place.phone) {
        content += '<div class="store-info-item">';
        content += '<i class="bi bi-telephone store-info-icon"></i>';
        content += '<span>' + place.phone + '</span>';
        content += '</div>';
    }
    
    content += '<div class="store-info-item">';
    content += '<i class="bi bi-tag store-info-icon"></i>';
    content += '<span>' + place.category_name + '</span>';
    content += '</div>';
    
    if (place.distance) {
        content += '<div class="store-info-item">';
        content += '<i class="bi bi-map store-info-icon"></i>';
        content += '<span>ÏïΩ ' + place.distance + 'm</span>';
        content += '</div>';
    }
    
    content += '</div>';
    content += '<div class="infowindow-buttons">';
    content += '<button class="info-btn btn-detail" onclick="goToStoreDetailFromMap(\'' + place.place_name + '\', \'' + place.id + '\')">';
    content += '<i class="bi bi-info-circle" style="margin-right: 4px;"></i>ÏÉÅÏÑ∏Î≥¥Í∏∞';
    content += '</button>';
    
    if (place.phone) {
        content += '<button class="info-btn btn-call" onclick="callStore(\'' + place.phone + '\')">';
        content += '<i class="bi bi-telephone" style="margin-right: 4px;"></i>Ï†ÑÌôî';
        content += '</button>';
    }
    
    content += '</div>';
    content += '</div>';
    content += '</div>';
    
    return content;
}

// ==================== Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò ====================
function clearMarkers() {
    for (let i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
    }
    markers = [];
}

function closeAllInfoWindows() {
    if (currentInfoWindow) {
        currentInfoWindow.close();
        currentInfoWindow = null;
    }
}

function closeCurrentInfoWindow() {
    closeAllInfoWindows();
}

function extractCategoryTag(categoryName) {
    if (!categoryName) return 'Í∏∞ÌÉÄ';
    
    const parts = categoryName.split(' > ');
    const lastPart = parts[parts.length - 1];
    
    if (lastPart.length > 15) {
        return lastPart.substring(0, 15) + '...';
    }
    
    return lastPart;
}

function goToStoreDetail(storeId) {
    window.location.href = '/solfood/user/store/detail/' + storeId;
}

function goToStoreDetailFromMap(placeName, placeId) {
    window.location.href = '/solfood/user/list?storeId=1';
}

function callStore(phoneNumber) {
    if (phoneNumber) {
        window.location.href = 'tel:' + phoneNumber;
    } else {
        alert('Ï†ÑÌôîÎ≤àÌò∏ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
    }
}

// ==================== Í≤ÄÏÉâ Í∏∞Îä• ====================

/**
 * Í≤ÄÏÉâ Ïã§Ìñâ Ìï®Ïàò
 */
function performSearch() {
    const searchInput = document.getElementById('searchInput');
    const keyword = searchInput.value.trim();
    
    if (!keyword) {
        alert('Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        searchInput.focus();
        return;
    }
    
    // Î°úÎî© ÌëúÏãú
    showLoading(true);
    
    // AJAXÎ°ú Í≤ÄÏÉâ ÏöîÏ≤≠
    fetch(`/solfood/user/store/search?keyword=${encodeURIComponent(keyword)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                isSearchMode = true;
                currentSearchKeyword = keyword;
                displaySearchResults(data.stores || [], keyword);
                updateSearchUI(keyword);
            } else {
                console.error('Í≤ÄÏÉâ Ïã§Ìå®:', data.message);
                alert('Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Í≤ÄÏÉâ ÏöîÏ≤≠ Ïã§Ìå®:', error);
            alert('Í≤ÄÏÉâ ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        })
        .finally(() => {
            showLoading(false);
        });
}

/**
 * Í∞ÄÍ≤å Î™©Î°ùÏùÑ ÌôîÎ©¥Ïóê ÌëúÏãú
 */
function displayStoreList(stores) {
    console.log('displayStoreList Ìò∏Ï∂úÎê®:', stores); // ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏
    
    const storeGrid = document.querySelector('.store-grid');
    if (!storeGrid) {
        console.error('store-grid ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        return;
    }
    
    // Í∏∞Ï°¥ Í∞ÄÍ≤å Ïπ¥ÎìúÎì§ Ï†úÍ±∞
    storeGrid.innerHTML = '';
    
    if (!stores || stores.length === 0) {
        console.log('Í∞ÄÍ≤å Î™©Î°ùÏù¥ ÎπÑÏñ¥ÏûàÏùå');
        storeGrid.innerHTML = `
            <div class="empty-result">
                <i class="bi bi-shop" style="font-size: 64px; color: #ddd; margin-bottom: 20px; display: block;"></i>
                <h3>Í∞ÄÍ≤åÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
                <p>Îã§Î•∏ Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌï¥Î≥¥ÏÑ∏Ïöî.</p>
            </div>
        `;
        return;
    }
    
    console.log(`Ï¥ù ${stores.length}Í∞úÏùò Í∞ÄÍ≤å Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ ÏãúÏûë`);
    
    // Ï≤´ Î≤àÏß∏ Í∞ÄÍ≤å Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÌôïÏù∏
    if (stores.length > 0) {
        console.log('Ï≤´ Î≤àÏß∏ Í∞ÄÍ≤å Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞:', stores[0]);
        console.log('Ï≤´ Î≤àÏß∏ Í∞ÄÍ≤å Îç∞Ïù¥ÌÑ∞ ÌÇ§Îì§:', Object.keys(stores[0]));
    }
    
    // Í∞ÄÍ≤å Ïπ¥ÎìúÎì§ ÏÉùÏÑ±
    stores.forEach((store, index) => {
        try {
            const storeCard = createStoreCardElement(store);
            if (storeCard && storeCard instanceof Node) {
                storeGrid.appendChild(storeCard);
            } else {
                console.error('createStoreCardElementÍ∞Ä Ïú†Ìö®Ìïú NodeÎ•º Î∞òÌôòÌïòÏßÄ ÏïäÏùå:', store, storeCard);
            }
        } catch (error) {
            console.error(`Í∞ÄÍ≤å Ïπ¥Îìú ÏÉùÏÑ± Ïã§Ìå® (index: ${index}):`, error, store);
        }
    });
}

/**
 * Í∞úÎ≥Ñ Í∞ÄÍ≤å Ïπ¥Îìú DOM ÏöîÏÜå ÏÉùÏÑ±
 */
function createStoreCardElement(store) {
    try {
        // ÌïÑÏàò Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
        if (!store) {
            console.error('store Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§:', store);
            return null;
        }
        
        const cardDiv = document.createElement('div');
        if (!cardDiv) {
            console.error('div ÏóòÎ¶¨Î®ºÌä∏ ÏÉùÏÑ± Ïã§Ìå®');
            return null;
        }
        
        cardDiv.className = 'store-card';
        cardDiv.setAttribute('data-category', String(store.storeCategory || ''));
        
        // ÏïàÏ†ÑÌïú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        const storeId = store.storeId || store.store_id;
        if (storeId) {
            cardDiv.onclick = () => goToStoreDetail(storeId);
        }
        
        // ÏïàÏ†ÑÌïú Î¨∏ÏûêÏó¥ Ï≤òÎ¶¨
        const safeName = String(store.storeName || store.store_name || 'Ïù¥Î¶Ñ ÏóÜÏùå');
        const safeCategory = String(store.storeCategory || store.store_category || 'Í∏∞ÌÉÄ');
        const safeImage = store.storeMainimage || store.store_mainimage || '';
        const safeAddress = store.storeAddress || store.store_address || '';
        const safeTel = store.storeTel || store.store_tel || '';
        const safeRating = Number(store.storeAvgstar || store.store_avgstar || 0);
        
        // Ïù¥ÎØ∏ÏßÄ Î∂ÄÎ∂Ñ
        let imageHtml = '';
        if (!safeImage || safeImage === '/img/default-restaurant.jpg') {
            imageHtml = `
                <div class="store-img" style="background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d;">
                    <i class="bi bi-shop" style="font-size: 40px;"></i>
                </div>
            `;
        } else {
            imageHtml = `
                <img src="${safeImage}" alt="${safeName}" class="store-img"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="store-img" style="background-color: #f8f9fa; display: none; align-items: center; justify-content: center; color: #6c757d;">
                    <i class="bi bi-shop" style="font-size: 40px;"></i>
                </div>
            `;
        }
        
        // Ï£ºÏÜå ÌëúÏãú (15Ïûê Ï†úÌïú)
        let addressHtml = '';
        if (safeAddress) {
            const displayAddress = safeAddress.length > 15 
                ? safeAddress.substring(0, 15) + '...'
                : safeAddress;
            addressHtml = `
                <div style="font-size: 11px; color: #666; margin-bottom: 3px;">
                    üìç ${displayAddress}
                </div>
            `;
        }
        
        // ÌèâÏ†ê ÌëúÏãú
        const ratingText = safeRating > 0 
            ? `‚≠ê ${safeRating}Ï†ê`
            : '‚≠ê Ïã†Í∑úÎß§Ïû•';
        
        // Ï†ÑÌôîÎ≤àÌò∏ ÌëúÏãú
        let phoneHtml = '';
        if (safeTel && safeTel !== 'Ï†ïÎ≥¥ÏóÜÏùå') {
            phoneHtml = `
                <div style="font-size: 10px; color: #28a745; margin-top: 2px;">
                    üìû ${safeTel}
                </div>
            `;
        }
        
        // innerHTML ÏïàÏ†ÑÌïòÍ≤å ÏÑ§Ï†ï
        try {
            cardDiv.innerHTML = `
                ${imageHtml}
                <div class="store-body">
                    <div class="store-name">${safeName}</div>
                    <div class="store-category">${safeCategory}</div>
                    ${addressHtml}
                    <div style="font-size: 12px;">
                        ${ratingText}
                    </div>
                    ${phoneHtml}
                    <i class="bi bi-heart like-icon"></i>
                </div>
            `;
        } catch (htmlError) {
            console.error('innerHTML ÏÑ§Ï†ï Ïã§Ìå®:', htmlError, store);
            return null;
        }
        
        return cardDiv;
        
    } catch (error) {
        console.error('createStoreCardElement Ïã§Ìñâ Ï§ë Ïò§Î•ò:', error, store);
        return null;
    }
}

/**
 * Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º ÌôîÎ©¥Ïóê ÌëúÏãú
 */
function displaySearchResults(stores, keyword) {
    const storeGrid = document.querySelector('.store-grid');
    
    if (!stores || stores.length === 0) {
        storeGrid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
                <i class="bi bi-search" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                <h3 style="margin-bottom: 8px;">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
                <p>'${keyword}'Ïóê ÎåÄÌïú Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                <button onclick="clearSearch()" class="btn btn-outline-primary mt-3">Ï†ÑÏ≤¥ Î™©Î°ù Î≥¥Í∏∞</button>
            </div>
        `;
        return;
    }
    
    // Í≤ÄÏÉâ Í≤∞Í≥ºÎ°ú Í∞ÄÍ≤å Ïπ¥Îìú ÏÉùÏÑ± - DOM ÏöîÏÜå Î∞©ÏãùÏúºÎ°ú ÌÜµÏùº
    storeGrid.innerHTML = '';
    stores.forEach((store, index) => {
        try {
            const storeCard = createStoreCardElement(store);
            if (storeCard && storeCard instanceof Node) {
                storeGrid.appendChild(storeCard);
            } else {
                console.error(`Í≤ÄÏÉâ Í≤∞Í≥º Ïπ¥Îìú ÏÉùÏÑ± Ïã§Ìå® (index: ${index}):`, store);
            }
        } catch (error) {
            console.error(`Í≤ÄÏÉâ Í≤∞Í≥º Ïπ¥Îìú ÏÉùÏÑ± Ïò§Î•ò (index: ${index}):`, error, store);
        }
    });
    
    console.log(`Í≤ÄÏÉâ ÏôÑÎ£å: '${keyword}'Î°ú ${stores.length}Í∞ú Í∞ÄÍ≤å Î∞úÍ≤¨`);
}

/**
 * Í≤ÄÏÉâ UI ÏóÖÎç∞Ïù¥Ìä∏
 */
function updateSearchUI(keyword) {
    // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù Ìï¥Ï†ú
    document.querySelectorAll('.category-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Í≤ÄÏÉâ ÏÉÅÌÉú ÌëúÏãúÎ•º ÏúÑÌïú Ìó§Îçî Ï∂îÍ∞Ä (ÏÑ†ÌÉùÏ†Å)
    const categoryContainer = document.querySelector('.category-container');
    let searchHeader = document.getElementById('searchHeader');
    
    if (!searchHeader) {
        searchHeader = document.createElement('div');
        searchHeader.id = 'searchHeader';
        searchHeader.style.cssText = `
            background: #e3f2fd; 
            padding: 12px 16px; 
            margin-bottom: 16px; 
            border-radius: 8px; 
            border-left: 4px solid #2196f3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        `;
        categoryContainer.insertBefore(searchHeader, categoryContainer.firstChild);
    }
    
    searchHeader.innerHTML = `
        <div>
            <i class="bi bi-search" style="color: #2196f3; margin-right: 8px;"></i>
            <strong>'${keyword}' Í≤ÄÏÉâ Í≤∞Í≥º</strong>
        </div>
        <button onclick="clearSearch()" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-x"></i> Í≤ÄÏÉâ Ìï¥Ï†ú
        </button>
    `;
}

/**
 * Í≤ÄÏÉâ Ìï¥Ï†ú Ìï®Ïàò
 */
function clearSearch() {
    isSearchMode = false;
    currentSearchKeyword = '';
    
    // Í≤ÄÏÉâÏ∞Ω Ï¥àÍ∏∞Ìôî
    document.getElementById('searchInput').value = '';
    
    // Í≤ÄÏÉâ Ìó§Îçî Ï†úÍ±∞
    const searchHeader = document.getElementById('searchHeader');
    if (searchHeader) {
        searchHeader.remove();
    }
    
    // 'Ï†ÑÏ≤¥' Ïπ¥ÌÖåÍ≥†Î¶¨ element Ï∞æÍ∏∞
    const allCategoryElement = document.querySelector('.category-item[onclick*="Ï†ÑÏ≤¥"]') || 
                               document.querySelector('.category-item[data-category="Ï†ÑÏ≤¥"]') ||
                               document.querySelector('.category-item:first-child');
    
    if (allCategoryElement) {
        selectCategory(allCategoryElement, 'Ï†ÑÏ≤¥');
    } else {
        // fallback: ÏßÅÏ†ë Ï†ÑÏ≤¥ Î™©Î°ù Î°úÎìú
        loadAllStores();
    }
}

/**
 * Ï†ÑÏ≤¥ Í∞ÄÍ≤å Î™©Î°ù ÏßÅÏ†ë Î°úÎìú (fallback Ìï®Ïàò)
 */
function loadAllStores() {
    // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
    document.querySelectorAll('.category-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Ï≤´ Î≤àÏß∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏïÑÏù¥ÌÖú ÌôúÏÑ±Ìôî (Î≥¥ÌÜµ 'Ï†ÑÏ≤¥')
    const firstCategory = document.querySelector('.category-item');
    if (firstCategory) {
        firstCategory.classList.add('active');
    }
    
    currentCategory = 'Ï†ÑÏ≤¥';
    
    // ÌòÑÏû¨ Î≥¥Í∏∞ Î™®ÎìúÏóê Îî∞Îùº Ï†ÅÏ†àÌïú Î°úÎìú Ìï®Ïàò Ìò∏Ï∂ú
    const mapContainer = document.getElementById('mapContainer');
    const listContainer = document.getElementById('listContainer');
    const mapDisplay = window.getComputedStyle(mapContainer).display;
    const listDisplay = window.getComputedStyle(listContainer).display;
    const isMapView = mapDisplay === 'flex';
    const isListView = listDisplay === 'block' || listDisplay === '';

    if (isListView) {
        fallbackFilterStoreList('Ï†ÑÏ≤¥');
    } else if (isMapView) {
        searchMapCategory('Ï†ÑÏ≤¥');
    } else {
        // Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Î¶¨Ïä§Ìä∏ Î∑∞Î°ú Ï†ÑÌôòÌïòÍ≥† Ï†ÑÏ≤¥ Î™©Î°ù ÌëúÏãú
        fallbackFilterStoreList('Ï†ÑÏ≤¥');
    }
    
    console.log('Ï†ÑÏ≤¥ Í∞ÄÍ≤å Î™©Î°ùÏùÑ Îã§Ïãú Î°úÎìúÌñàÏäµÎãàÎã§.');
}

/**
 * Î¶¨Ïä§Ìä∏ Î∑∞Î°ú Ï†ÑÌôò
 */
function showListView() {
    const mapContainer = document.getElementById('mapContainer');
    const listContainer = document.getElementById('listContainer');
    
    if (mapContainer && listContainer) {
        mapContainer.style.display = 'none';
        listContainer.style.display = 'block';
        
        // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        const mapBtn = document.getElementById('mapViewBtn');
        const listBtn = document.getElementById('listViewBtn');
        
        if (mapBtn && listBtn) {
            mapBtn.classList.remove('active');
            listBtn.classList.add('active');
        }
    }
}

/**
 * Îßµ Î∑∞Î°ú Ï†ÑÌôò
 */
function showMapView() {
    const mapContainer = document.getElementById('mapContainer');
    const listContainer = document.getElementById('listContainer');
    
    if (mapContainer && listContainer) {
        listContainer.style.display = 'none';
        mapContainer.style.display = 'flex';
        
        // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        const mapBtn = document.getElementById('mapViewBtn');
        const listBtn = document.getElementById('listViewBtn');
        
        if (mapBtn && listBtn) {
            listBtn.classList.remove('active');
            mapBtn.classList.add('active');
        }
    }
}

/**
 * ÏÑúÎ≤ÑÏóêÏÑú Ï†ÑÏ≤¥ Í∞ÄÍ≤å Î™©Î°ùÏùÑ Îã§Ïãú Í∞ÄÏ†∏ÏôÄÏÑú ÌëúÏãúÌïòÎäî fallback Ìï®Ïàò
 */
function fallbackFilterStoreList(category) {
    showLoading(true);
    
    const url = category === 'Ï†ÑÏ≤¥' ? 
        '/solfood/user/store/stores' : 
        `/solfood/user/store/category?category=${encodeURIComponent(category)}`;
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Î¶¨Ïä§Ìä∏ Ïª®ÌÖåÏù¥ÎÑà ÌëúÏãú
                showListView();
                displayStoreList(data.stores || []);
            } else {
                console.error('Í∞ÄÍ≤å Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®:', data.message);
                alert('Í∞ÄÍ≤å Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        })
        .catch(error => {
            console.error('Í∞ÄÍ≤å Î™©Î°ù Ï°∞Ìöå Ïò§Î•ò:', error);
            alert('Í∞ÄÍ≤å Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        })
        .finally(() => {
            showLoading(false);
        });
}

// Ï§ëÎ≥µÎêú createStoreCard Ìï®Ïàò Ï†úÍ±∞ - createStoreCardElementÎ°ú ÌÜµÏùº

/**
 * Î°úÎî© ÌëúÏãú Ìï®Ïàò
 */
function showLoading(show) {
    let loadingElement = document.getElementById('searchLoading');
    
    if (show) {
        if (!loadingElement) {
            loadingElement = document.createElement('div');
            loadingElement.id = 'searchLoading';
            loadingElement.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 255, 255, 0.9);
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 9999;
                text-align: center;
            `;
            loadingElement.innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Í≤ÄÏÉâ Ï§ë...</span>
                </div>
                <div style="margin-top: 10px; color: #666;">Í≤ÄÏÉâ Ï§ë...</div>
            `;
            document.body.appendChild(loadingElement);
        }
        loadingElement.style.display = 'block';
    } else {
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
    }
}

/**
 * Enter ÌÇ§Î°ú Í≤ÄÏÉâ Ïã§Ìñâ
 */
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
}); 