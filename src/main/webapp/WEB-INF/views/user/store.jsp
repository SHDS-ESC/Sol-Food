<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ÏãùÎãπ Î™©Î°ù</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Ïπ¥Ïπ¥Ïò§Îßµ API -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8f9034d6cf1da650e02b54751e02fcb3&libraries=services"></script>

    <style>
        body {
            margin: 0;
            background-color: #f5d6db; /* Ïó∞Î∂ÑÌôç Î∞∞Í≤Ω */
            font-family: 'Apple SD Gothic Neo', sans-serif;
        }

        .app-container {
            max-width: 430px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            padding-bottom: 80px; /* ÌïòÎã® Î∞î Í≥µÍ∞Ñ */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .toggle-btns {
            display: flex;
            gap: 5px;
        }

        .search-bar {
            padding: 0 15px;
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        .category-scroll {
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 15px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .category-scroll::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }

        .category-btn {
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 13px;
            display: inline-block;
            margin-right: 8px;
            white-space: nowrap;
            cursor: pointer;
        }

        .category-btn.active {
            background-color: #0d6efd !important;
            color: white !important;
        }

        .store-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 10px 15px;
        }

        .store-card {
            border: 1px solid #ccc;
            border-radius: 10px;
            overflow: hidden;
            background: #fff;
        }

        .store-img {
            width: 100%;
            height: 120px;
            background-color: #eee;
            object-fit: cover;
        }

        .store-body {
            padding: 10px;
            font-size: 13px;
            position: relative;
        }

        .store-name {
            font-weight: bold;
            font-size: 14px;
        }

        .like-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #ff4d6d;
            font-size: 16px;
        }

        /* ÏßÄÎèÑ Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä */
        .map-container {
            width: 100%;
            height: calc(100vh - 200px);
            display: none;
            flex-direction: column;
        }

        .map-view {
            flex: 1;
        }

        .list-container {
            display: block;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: #fff;
            border-top: 1px solid #ccc;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }

        .bottom-nav a {
            color: #555;
            text-decoration: none;
            font-size: 12px;
            text-align: center;
        }

        .bottom-nav i {
            font-size: 20px;
            display: block;
        }

        .btn-active {
            background-color: #0d6efd !important;
            color: white !important;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading i {
            font-size: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ïª§Ïä§ÌÖÄ ÎßàÏª§ Ïä§ÌÉÄÏùº */
        .custom-marker {
            background: #ff4d6d;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<div class="app-container">

    <!-- ‚úÖ ÏÉÅÎã® Ìó§Îçî -->
    <div class="header">
        <div><strong>Î°úÍ≥†</strong></div>
        <div class="toggle-btns">
            <button id="mapBtn" class="btn btn-outline-secondary btn-sm" onclick="showMap()">ÏßÄÎèÑ</button>
            <button id="listBtn" class="btn btn-outline-secondary btn-sm btn-active" onclick="showList()">Î™©Î°ù</button>
        </div>
        <div><i class="bi bi-list" style="font-size: 20px;"></i></div>
    </div>

    <!-- ‚úÖ Í≤ÄÏÉâÎ∞î -->
    <div class="search-bar">
        <input type="text" class="form-control" placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî">
        <button class="btn btn-primary">Í≤ÄÏÉâ</button>
    </div>

    <!-- ‚úÖ Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäº (ÎèôÏ†Å Î°úÎî©) -->
    <div class="category-scroll" id="categoryContainer">
        <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäºÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
    </div>

    <!-- ‚úÖ ÏßÄÎèÑ Ïª®ÌÖåÏù¥ÎÑà -->
    <div id="mapContainer" class="map-container">
        <div id="map" class="map-view" style="width:100%;height:100%;"></div>
    </div>

    <!-- ‚úÖ ÏãùÎãπ Ïπ¥Îìú Î¶¨Ïä§Ìä∏ -->
    <div id="listContainer" class="list-container">
                <div class="store-grid">
            <c:forEach items="${store}" var="store">
            <div class="store-card" data-category="${store.storeCategory}">
                <c:choose>
                    <c:when test="${empty store.storeMainimage || store.storeMainimage eq '/img/default-restaurant.jpg'}">
                        <div class="store-img" style="background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d;">
                            <i class="bi bi-shop" style="font-size: 40px;"></i>
                        </div>
                    </c:when>
                    <c:otherwise>
                        <img src="${store.storeMainimage}" alt="${store.storeName}" class="store-img" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="store-img" style="background-color: #f8f9fa; display: none; align-items: center; justify-content: center; color: #6c757d;">
                            <i class="bi bi-shop" style="font-size: 40px;"></i>
                        </div>
                    </c:otherwise>
                </c:choose>
                <div class="store-body">
                    <div class="store-name">${store.storeName}</div>
                    <div class="store-category">${store.storeCategory}</div>
                    <c:if test="${not empty store.storeAddress}">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">
                            üìç <c:choose>
                                <c:when test="${fn:length(store.storeAddress) > 15}">
                                    ${fn:substring(store.storeAddress, 0, 15)}...
                                </c:when>
                                <c:otherwise>
                                    ${store.storeAddress}
                                </c:otherwise>
                            </c:choose>
                        </div>
                    </c:if>
                    <div style="font-size: 12px;">
                        <c:choose>
                            <c:when test="${store.storeAvgstar > 0}">
                                ‚≠ê ${store.storeAvgstar}Ï†ê
                            </c:when>
                            <c:otherwise>
                                ‚≠ê Ïã†Í∑úÎß§Ïû•
                            </c:otherwise>
                        </c:choose>
                    </div>
                    <c:if test="${not empty store.storeTel && store.storeTel ne 'Ï†ïÎ≥¥ÏóÜÏùå'}">
                        <div style="font-size: 10px; color: #28a745; margin-top: 2px;">
                            üìû ${store.storeTel}
                        </div>
                    </c:if>
                    <i class="bi bi-heart like-icon"></i> <!-- Ï∞ú Í∏∞Îä• -->
                </div>
            </div>
            </c:forEach>
        </div>
    </div>
</div>

<!-- ‚úÖ ÌïòÎã®Î∞î -->
<div class="bottom-nav">
    <a href="#"><i class="bi bi-house"></i>Ìôà</a>
    <a href="#"><i class="bi bi-list-check"></i>Î¶¨Ïä§Ìä∏</a>
    <a href="#"><i class="bi bi-calendar2-week"></i>Ï∫òÎ¶∞Îçî</a>
    <a href="#"><i class="bi bi-heart-fill"></i>Ï∞ú</a>
    <a href="#"><i class="bi bi-person-circle"></i>ÎßàÏù¥</a>
</div>

<script>
let map;
let currentPosition;
let placesService;
let markers = [];
let currentCategory = 'Ï†ÑÏ≤¥';
let categoryConfig = null; // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï Ï†ÄÏû•

// ÌéòÏù¥ÏßÄ Î°úÎìúÏãú Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï Î∂àÎü¨Ïò§Í∏∞
document.addEventListener('DOMContentLoaded', function() {
    loadCategoryConfig();
});

// Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï Î°úÎìú
function loadCategoryConfig() {
    fetch('/solfood/user/api/category/config')
        .then(response => response.json())
        .then(data => {
            categoryConfig = data;
            generateCategoryButtons();
        })
        .catch(error => {
            console.error('Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï Î°úÎî© Ïã§Ìå®:', error);
            // Ïã§Ìå®Ïãú Í∏∞Î≥∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÇ¨Ïö©
            generateDefaultCategories();
        });
}

// Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäº ÎèôÏ†Å ÏÉùÏÑ±
function generateCategoryButtons() {
    const container = document.getElementById('categoryContainer');
    container.innerHTML = '';
    
    if (categoryConfig && categoryConfig.categories) {
        categoryConfig.categories.forEach((category, index) => {
            const button = document.createElement('button');
            button.className = 'btn btn-outline-primary category-btn' + (index === 0 ? ' active' : '');
            button.onclick = () => searchByCategory(category);
            button.textContent = category;
            container.appendChild(button);
        });
    }
}

// Í∏∞Î≥∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÉùÏÑ± (Î∞±ÏóÖÏö©)
function generateDefaultCategories() {
    const container = document.getElementById('categoryContainer');
    const defaultCategories = ['Ï†ÑÏ≤¥', 'ÌïúÏãù', 'Ïπ¥Ìéò', 'ÏùºÏãù', 'Ï§ëÏãù', 'ÏñëÏãù', 'ÏπòÌÇ®', 'ÌîºÏûê', 'Ìå®Ïä§Ìä∏Ìë∏Îìú', 'Î∂ÑÏãù', 'Î≤†Ïù¥Ïª§Î¶¨'];
    
    container.innerHTML = '';
    defaultCategories.forEach((category, index) => {
        const button = document.createElement('button');
        button.className = 'btn btn-outline-primary category-btn' + (index === 0 ? ' active' : '');
        button.onclick = () => searchByCategory(category);
        button.textContent = category;
        container.appendChild(button);
    });
}

function showMap() {
    // Î≤ÑÌäº Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
    document.getElementById('mapBtn').classList.add('btn-active');
    document.getElementById('listBtn').classList.remove('btn-active');
    
    // Ïª®ÌÖåÏù¥ÎÑà ÌëúÏãú/Ïà®ÍπÄ
    document.getElementById('mapContainer').style.display = 'flex';
    document.getElementById('listContainer').style.display = 'none';
    
    // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî (ÌïúÎ≤àÎßå)
    if (!map) {
        initializeMap();
    } else {
        // ÏßÄÎèÑ ÌÅ¨Í∏∞ Ïû¨Ï°∞Ï†ï
        setTimeout(() => {
            map.relayout();
            if (currentPosition) {
                map.setCenter(currentPosition);
            }
        }, 100);
    }
}

function showList() {
    // Î≤ÑÌäº Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
    document.getElementById('listBtn').classList.add('btn-active');
    document.getElementById('mapBtn').classList.remove('btn-active');
    
    // Ïª®ÌÖåÏù¥ÎÑà ÌëúÏãú/Ïà®ÍπÄ
    document.getElementById('listContainer').style.display = 'block';
    document.getElementById('mapContainer').style.display = 'none';
}

function initializeMap() {
    // ÌòÑÏû¨ ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                currentPosition = new kakao.maps.LatLng(lat, lng);
                
                createMap(currentPosition);
            },
            function(error) {
                console.error('ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§:', error);
                // Í∏∞Î≥∏ ÏúÑÏπò (ÏÑúÏö∏ÏãúÏ≤≠)
                const defaultPosition = new kakao.maps.LatLng(37.566826, 126.9786567);
                currentPosition = defaultPosition;
                createMap(defaultPosition);
            }
        );
    } else {
        alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎäî ÏúÑÏπò ÏÑúÎπÑÏä§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
        // Í∏∞Î≥∏ ÏúÑÏπò (ÏÑúÏö∏ÏãúÏ≤≠)
        const defaultPosition = new kakao.maps.LatLng(37.566826, 126.9786567);
        currentPosition = defaultPosition;
        createMap(defaultPosition);
    }
}

function createMap(position) {
    const mapContainer = document.getElementById('map');
    const mapOption = {
        center: position, // ÏßÄÎèÑÏùò Ï§ëÏã¨Ï¢åÌëú
        level: 3 // ÏßÄÎèÑÏùò ÌôïÎåÄ Î†àÎ≤®
    };

    // ÏßÄÎèÑ ÏÉùÏÑ±
    map = new kakao.maps.Map(mapContainer, mapOption);
    
    // Places ÏÑúÎπÑÏä§ Í∞ùÏ≤¥ ÏÉùÏÑ±
    placesService = new kakao.maps.services.Places();

    // ÌòÑÏû¨ ÏúÑÏπò ÎßàÏª§ ÏÉùÏÑ±
    const myLocationMarker = new kakao.maps.Marker({
        position: position,
        map: map
    });

    // Ïù∏Ìè¨ÏúàÎèÑÏö∞Î°ú ÌòÑÏû¨ ÏúÑÏπò ÌëúÏãú
    const infowindow = new kakao.maps.InfoWindow({
        content: '<div style="padding:5px;font-size:12px;color:#0066cc;font-weight:bold;">üìç ÎÇ¥ ÏúÑÏπò</div>'
    });
    infowindow.open(map, myLocationMarker);

    // ÏßÄÎèÑ ÌÅ¨Í∏∞ Ïû¨Ï°∞Ï†ï (ÏßÄÎèÑÍ∞Ä ÌëúÏãúÎê† Îïå Ìò∏Ï∂ú)
    setTimeout(() => {
        map.relayout();
        map.setCenter(position);
        // Ï¥àÍ∏∞ Ï†ÑÏ≤¥ Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ
        searchByCategory('Ï†ÑÏ≤¥');
    }, 100);
}

// Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í≤ÄÏÉâ
function searchByCategory(category) {
    // Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    currentCategory = category;
    
    // Î™©Î°ù ÌôîÎ©¥Ïùò Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅ
    filterStoreList(category);
    
    // ÏßÄÎèÑÍ∞Ä ÌôúÏÑ±ÌôîÎêú ÏÉÅÌÉúÏóêÏÑúÎßå ÏßÄÎèÑ Í≤ÄÏÉâ
    if (map && placesService && currentPosition) {
        // Í∏∞Ï°¥ ÎßàÏª§Îì§ Ï†úÍ±∞
        clearMarkers();
        
        // CategoryPropertiesÏóêÏÑú Í≤ÄÏÉâ ÌÇ§ÏõåÎìú Í∞ÄÏ†∏Ïò§Í∏∞
        let keyword = '';
        if (categoryConfig && categoryConfig.searchKeywords) {
            keyword = categoryConfig.searchKeywords[category] || category;
        } else {
            keyword = category; // Î∞±ÏóÖÏö©
        }
        
        // ÌÇ§ÏõåÎìú Í≤ÄÏÉâ ÏòµÏÖò
        const options = {
            location: currentPosition,
            radius: 1000, // 1km Î∞òÍ≤Ω
            sort: kakao.maps.services.SortBy.DISTANCE
        };
        
        // ÌÇ§ÏõåÎìúÎ°ú Ïû•ÏÜå Í≤ÄÏÉâ
        placesService.keywordSearch(keyword, placesSearchCB, options);
    }
}

// Î™©Î°ù ÌôîÎ©¥ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅ Ìï®Ïàò (Ajax ÏÇ¨Ïö©)
function filterStoreList(category) {
    // Î°úÎî© ÌëúÏãú
    showLoading();
    
    // AjaxÎ°ú Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    fetch('/solfood/user/api/store/category/' + encodeURIComponent(category))
        .then(response => response.json())
        .then(data => {
            updateStoreGrid(data);
        })
        .catch(error => {
            console.error('Ïπ¥ÌÖåÍ≥†Î¶¨ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®:', error);
            // Ïã§Ìå®Ïãú Í∏∞Ï°¥ Î∞©ÏãùÏúºÎ°ú ÌïÑÌÑ∞ÎßÅ
            fallbackFilterStoreList(category);
        });
}

// Î°úÎî© ÌëúÏãú Ìï®Ïàò
function showLoading() {
    const storeGrid = document.querySelector('.store-grid');
    storeGrid.innerHTML = '<div class="loading"><i class="bi bi-arrow-clockwise"></i><br>Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
}

// Í∏∞Ï°¥ Î∞©Ïãù ÌïÑÌÑ∞ÎßÅ (Î∞±ÏóÖÏö©)
function fallbackFilterStoreList(category) {
    const storeCards = document.querySelectorAll('.store-card');
    
    storeCards.forEach(card => {
        const storeCategory = card.querySelector('.store-category');
        if (storeCategory) {
            const storeCategoryText = storeCategory.textContent.trim();
            
            if (category === 'Ï†ÑÏ≤¥') {
                card.style.display = 'block';
            } else {
                if (isCategoryMatch(storeCategoryText, category)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            }
        }
    });
}

// Í∞ÄÍ≤å Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
function updateStoreGrid(stores) {
    const storeGrid = document.querySelector('.store-grid');
    storeGrid.innerHTML = '';
    
    stores.forEach(store => {
        const storeCard = createStoreCard(store);
        storeGrid.appendChild(storeCard);
    });
}

// Í∞ÄÍ≤å Ïπ¥Îìú ÏÉùÏÑ± Ìï®Ïàò
function createStoreCard(store) {
    const card = document.createElement('div');
    card.className = 'store-card';
    card.setAttribute('data-category', store.storeCategory);
    
    let imageHtml = '';
    if (!store.storeMainimage || store.storeMainimage === '/img/default-restaurant.jpg') {
        imageHtml = '<div class="store-img" style="background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d;"><i class="bi bi-shop" style="font-size: 40px;"></i></div>';
    } else {
        imageHtml = '<img src="' + store.storeMainimage + '" alt="' + store.storeName + '" class="store-img" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';"><div class="store-img" style="background-color: #f8f9fa; display: none; align-items: center; justify-content: center; color: #6c757d;"><i class="bi bi-shop" style="font-size: 40px;"></i></div>';
    }
    
    let addressHtml = '';
    if (store.storeAddress && store.storeAddress.trim() !== '') {
        const shortAddress = store.storeAddress.length > 15 ? store.storeAddress.substring(0, 15) + '...' : store.storeAddress;
        addressHtml = '<div style="font-size: 11px; color: #666; margin-bottom: 3px;">üìç ' + shortAddress + '</div>';
    }
    
    let starHtml = '';
    if (store.storeAvgstar > 0) {
        starHtml = '‚≠ê ' + store.storeAvgstar + 'Ï†ê';
    } else {
        starHtml = '‚≠ê Ïã†Í∑úÎß§Ïû•';
    }
    
    let phoneHtml = '';
    if (store.storeTel && store.storeTel !== 'Ï†ïÎ≥¥ÏóÜÏùå') {
        phoneHtml = '<div style="font-size: 10px; color: #28a745; margin-top: 2px;">üìû ' + store.storeTel + '</div>';
    }
    
    card.innerHTML = imageHtml + 
        '<div class="store-body">' +
        '<div class="store-name">' + store.storeName + '</div>' +
        '<div class="store-category">' + store.storeCategory + '</div>' +
        addressHtml +
        '<div style="font-size: 12px;">' + starHtml + '</div>' +
        phoneHtml +
        '<i class="bi bi-heart like-icon"></i>' +
        '</div>';
    
    return card;
}

// Ïπ¥ÌÖåÍ≥†Î¶¨ Îß§Ïπ≠ Ìï®Ïàò (CategoryProperties ÏÇ¨Ïö©)
function isCategoryMatch(storeCategory, selectedCategory) {
    if (selectedCategory === 'Ï†ÑÏ≤¥') {
        return true;
    }
    
    // CategoryPropertiesÏóêÏÑú Îß§Ïπ≠ ÌÇ§ÏõåÎìú Í∞ÄÏ†∏Ïò§Í∏∞
    if (categoryConfig && categoryConfig.matchingKeywords) {
        const matchingKeywords = categoryConfig.matchingKeywords[selectedCategory];
        if (matchingKeywords) {
            const storeCat = storeCategory.toLowerCase();
            return matchingKeywords.some(keyword => 
                storeCat.includes(keyword.toLowerCase())
            );
        }
    }
    
    // Î∞±ÏóÖÏö©: Í∏∞Î≥∏ Îß§Ïπ≠
    return storeCategory.toLowerCase().includes(selectedCategory.toLowerCase());
}

// Í≤ÄÏÉâ Í≤∞Í≥º ÏΩúÎ∞± Ìï®Ïàò
function placesSearchCB(data, status, pagination) {
    if (status === kakao.maps.services.Status.OK) {
        // Í≤ÄÏÉâÎêú Ïû•ÏÜåÎì§ÏùÑ ÏßÄÎèÑÏóê ÎßàÏª§Î°ú ÌëúÏãú
        for (let i = 0; i < data.length; i++) {
            displayMarker(data[i]);
        }
    } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
        console.log('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.');
    } else if (status === kakao.maps.services.Status.ERROR) {
        console.log('Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
}

// ÎßàÏª§ ÌëúÏãú Ìï®Ïàò
function displayMarker(place) {
    const marker = new kakao.maps.Marker({
        map: map,
        position: new kakao.maps.LatLng(place.y, place.x)
    });
    
    markers.push(marker);
    
    // ÎßàÏª§Ïóê ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Îì±Î°ù
    kakao.maps.event.addListener(marker, 'click', function() {
        // Ïù∏Ìè¨ÏúàÎèÑÏö∞ ÎÇ¥Ïö©
        let content = '<div style="padding:10px;min-width:150px;">';
        content += '<div style="font-weight:bold;margin-bottom:5px;">' + place.place_name + '</div>';
        content += '<div style="font-size:12px;color:#666;margin-bottom:3px;">' + place.category_name + '</div>';
        content += '<div style="font-size:12px;color:#666;">' + (place.road_address_name || place.address_name) + '</div>';
        if (place.phone) {
            content += '<div style="font-size:12px;color:#0066cc;margin-top:5px;">' + place.phone + '</div>';
        }
        content += '</div>';
        
        const infowindow = new kakao.maps.InfoWindow({
            content: content
        });
        
        infowindow.open(map, marker);
    });
}

// Í∏∞Ï°¥ ÎßàÏª§Îì§ Ï†úÍ±∞
function clearMarkers() {
    for (let i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
    }
    markers = [];
}
</script>

</body>
</html>
